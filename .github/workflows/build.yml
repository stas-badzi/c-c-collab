name: Build & Upload Binaries

on:
  push:
    branches:
      - main

jobs:
  build-msys:
    name: Build program using MSYS2
    runs-on: windows-latest
    steps:
      - name: Checkout source code
        uses: actions/checkout@v4
      - name: Setup MSYS2
        uses: msys2/setup-msys2@v2
      - name: Install Programs
        shell: msys2 {0}
        run: |
          echo Y > yes.in
          pacman -S make < yes.in
          pacman -S zip < yes.in
          (echo && echo && echo Y) > yes.in 
          pacman -S --needed base-devel mingw-w64-ucrt-x86_64-toolchain < yes.in
          rm yes.in
      - name: Compile code
        shell: msys2 {0}
        run: |
          export PATH="/c/Program Files/dotnet:/ucrt64/bin:$PATH"
          make release sudo=0
      - name: Upload C++ binaries
        uses: actions/upload-artifact@v4
        with:
          name: Msys2CppBin
          path: bin/*C++*.zip
      - name: Upload C# binaries
        uses: actions/upload-artifact@v4
        with:
          name: Msys2CsBin
          path: bin/*C#*.zip

  build-cygwin:
    name: Build program using Cygwin
    runs-on: windows-latest
    steps:
      - name: Checkout source code
        uses: actions/checkout@v4
      - name: Set up Cygwin
        uses: egor-tensin/setup-cygwin@v4
        with:
          packages: gcc-g++
      - name: Install Programs
        shell: C:\tools\cygwin\bin\bash.exe --login -o igncr '{0}'
        run: |
          ls
      - name: Compile code
        shell: C:\tools\cygwin\bin\bash.exe --login -o igncr '{0}'
        run: |
          export PATH="/c/Program Files/dotnet:$PATH"
          make
      - name: Upload C++ binaries
        uses: actions/upload-artifact@v4
        with:
          name: Cygwin2CppBin
          path: bin/*C++*.zip
      - name: Upload C# binaries
        uses: actions/upload-artifact@v4
        with:
          name: Cygwin2CsBin
          path: bin/*C#*.zip
  
  build-windows:
    name: Build program using Windows
    runs-on: windows-latest
    steps:
      - name: Checkout source code
        uses: actions/checkout@v4
      - name: Set up Clang
        uses: egor-tensin/setup-clang@v1
      - name: Install Programs
        shell: pwsh
        run: |
          Invoke-WebRequest -Uri "https://github.com/leok7v/gnuwin32.mirror/archive/refs/heads/master.zip" -OutFile "gnuwin32.zip" -Verbose
          Expand-Archive -Force gnuwin32.zip .
          del gnuwin32.zip
          ren gnuwin32.mirror-master gnuwin32
          copy gnuwin32\bin\* .
          del echo.exe
          
      - name: get verisons
        shell: cmd
        run: |
          .\make.exe -v
          .\uname.exe -a
      - name: Compile code
        shell: cmd
        env:
          CC: clang
          CXX: clang++
        run: |
          set PATH="%PATH%;$PWD\gnuwin32\bin"
          make release sudo=0
          
      - name: Upload C++ binaries
        uses: actions/upload-artifact@v4
        with:
          name: WindowsCppBin
          path: bin/*C++*.zip
      - name: Upload C# binaries
        uses: actions/upload-artifact@v4
        with:
          name: WindowsCsBin
          path: bin/*C#*.zip

  build-ubuntu:
    name: Build program using Ubuntu
    runs-on: ubuntu-latest
    steps:
      - name: Checkout source code
        uses: actions/checkout@v4
      - name: Install Programs
        shell: sh
        run: |
          sudo apt-get install -y dotnet-sdk-8.0
      - name: Compile code
        shell: bash
        run: |
          make release sudo=0
      - name: Upload C++ binaries
        uses: actions/upload-artifact@v4
        with:
          name: UbuntuCppBin
          path: bin/*C++*.tar.gz
      - name: Upload C# binaries
        uses: actions/upload-artifact@v4
        with:
          name: UbuntuCsBin
          path: bin/*C#*.tar.gz
