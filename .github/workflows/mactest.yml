name: Test MacOS

on:
  push:
    branches:
      - '**'

jobs:
  test-macos-arm64:
    permissions:
      contents: read
    name: Build program using Arm64 MacOS
    runs-on: macos-15
    steps:
      - name: Test MacOS Version
        shell: bash
        run: sw_vers -productVersion | cut -d '.' -f 1,2 && uname -a
  
  test-macos-x64:
    permissions:
      contents: read
    name: Build program using x64 MacOS 13
    runs-on: macos-13
    steps:
      - name: Test MacOS Version
        shell: bash
        run: sw_vers -productVersion | cut -d '.' -f 1,2 && uname -a
  test-macos-26:
    permissions:
      contents: read
    name: Build program using x64 MacOS 26
    runs-on: macos-26
    steps:
      - name: Test MacOS Version
        shell: bash
        run: sw_vers -productVersion | cut -d '.' -f 1,2 && uname -a
  
  test-macos-docker-x64:
    permissions:
      contents: read
    name: Build program using x64 MacOS 15 (Docker)
    runs-on: macos-13
    steps:
      - name: Intall UTM
        run: |
          set -x
          tempd=$(mktemp -d)
          curl https://github.com/utmapp/UTM/releases/latest/download/UTM.dmg > $tempd/pkg.dmg
          listing=$(sudo hdiutil attach $tempd/pkg.dmg | grep Volumes)
          volume=$(echo "$listing" | cut -f 3)
          if [ -e "$volume"/*.app ]; then
            sudo cp -rf "$volume"/*.app /Applications
          elif [ -e "$volume"/*.pkg ]; then
            package=$(ls -1 "$volume" | grep .pkg | head -1)
            sudo installer -pkg "$volume"/"$package" -target /
          fi
          sudo hdiutil detach "$(echo "$listing" | cut -f 1)"
          rm -rf $tempd
          set +x
      - name: Test MacOS Version
        shell: bash
        run: sw_vers -productVersion | cut -d '.' -f 1,2 && uname -a
